#!/bin/bash

if [ $# -eq 3 ]; then
  APPNAME=$1
  AFFINITY=$2
  BUILD=$3
  shift 3
elif [$# -eq 0 ]; then 
  APPNAME="tguard"
  AFFINITY="0-4/2"
  BUILD="build/linux/gcc/x86_64"
else
  echo ""
  echo "        Usage: $0 [APPNAME_NAME] [APPNAME_CORE_TARGET] [BUILD]"
  echo ""
  exit 1
fi

#######################################################################

CONF=tmp/$APPNAME.cfg

WKSP=$APPNAME.wksp
WKSP_PAGE_CNT=3
WKSP_PAGE_SZ=gigantic
WKSP_PERM=0600

POD_SZ=16384
CNC_APP_SZ=4032

# Settings to support 1+MTPS
TG_MTU=2048
TG_SLOT_CNT=4 # leaders has 4 consecutive slots 
TG_BUFF_CNT=2 # 0: data   1: code
TG_SLOT_SHREDS_MAX=$((128*1024)) # max data shreds in a slot: 128*1024 *4T/shred /0.4ms => support 1.3 MTPS
TG_DCACHE_DEPTH=$(( TG_SLOT_SHREDS_MAX * TG_BUFF_CNT * TG_SLOT_CNT ))
TG_MCACHE_DEPTH=8192    # no need to be same size as dcache, use smaller for speediness
TG_TCACHE_DEPTH=4194302 # capable of dedup-ing 4+sec's shreds from 1MTPS operation
TG_TCACHE_MAP_CNT=0

#######################################################################


# No logging by file as default to avoid disk running out of space from long runs
FD_LOG_PATH=""
export FD_LOG_PATH

"$BUILD"/bin/fd_wksp_ctl delete "$WKSP" # Okay if fails ... might not exist already
"$BUILD"/bin/fd_wksp_ctl new "$WKSP" "$WKSP_PAGE_CNT" "$WKSP_PAGE_SZ" "$AFFINITY" "$WKSP_PERM" || exit $?

POD=$("$BUILD"/bin/fd_pod_ctl new "$WKSP" "$POD_SZ") || exit $?

MAIN_CNC=$("$BUILD"/bin/fd_tango_ctl new-cnc "$WKSP" 0 tic "$CNC_APP_SZ") || exit $?
"$BUILD"/bin/fd_pod_ctl                              \
  insert "$POD" cstr "$APPNAME".main.cnc "$MAIN_CNC" \
  || exit $?

# Using 18433 to match default lazy = fd_tempo_lazy_default( DEPTH=8192 ),
#   otherwise fd_tempo_lazy_default( TG_DCACHE_DEPTH=1,048,576 ) gives 2359297, 
#   too large/slow as housekeep interval.
#     1048576/ 8192 = 128.0
#     2359297/18433 = 127.9
LAZY=18433

## create QOS first to avoid being pushed really behind as MON is quite big

## tqos, use unique cnc type '4'
TQOS_CNC=`$BUILD/bin/fd_tango_ctl new-cnc $WKSP 4 tic $CNC_APP_SZ` || exit $?
$BUILD/bin/fd_pod_ctl                           \
  insert $POD cstr $APPNAME.tqos.cnc  $TQOS_CNC \
  insert $POD long $APPNAME.tqos.lazy $LAZY     \
  || exit $?

## tmon, use an unique cnc type '3'
TMON_CNC=`$BUILD/bin/fd_tango_ctl new-cnc $WKSP 3 tic $CNC_APP_SZ` || exit $?
$BUILD/bin/fd_pod_ctl                           \
  insert $POD cstr $APPNAME.tmon.cnc  $TMON_CNC \
  insert $POD long $APPNAME.tmon.lazy $LAZY     \
  || exit $?
TCACHE=`$BUILD/bin/fd_tango_ctl new-tcache $WKSP         $TG_TCACHE_DEPTH $TG_TCACHE_MAP_CNT` || exit $?
MCACHE=`$BUILD/bin/fd_tango_ctl new-mcache $WKSP         $TG_MCACHE_DEPTH 0 0`                || exit $?
DCACHE=`$BUILD/bin/fd_tango_ctl new-dcache $WKSP $TG_MTU $TG_DCACHE_DEPTH 1 1 0`              || exit $?
FSEQ=`  $BUILD/bin/fd_tango_ctl new-fseq   $WKSP 0`                                           || exit $?
$BUILD/bin/fd_pod_ctl                           \
  insert $POD cstr $APPNAME.tmon.tcache $TCACHE \
  insert $POD cstr $APPNAME.tmon.mcache $MCACHE \
  insert $POD cstr $APPNAME.tmon.dcache $DCACHE \
  insert $POD cstr $APPNAME.tmon.fseq   $FSEQ   \
  || exit $?


BASE_ARGS="--pod $POD --cfg $APPNAME"
RUN_ARGS="$BASE_ARGS --log-app $APPNAME --log-thread main"
MON_ARGS="$BASE_ARGS --log-app $APPNAME --log-thread mon"

#######################################################################

mkdir -pv "$(dirname "$CONF")" || exit $?
echo "#!/bin/bash"             >  "$CONF"
{
  echo "# AUTOGENERATED"
  echo "BUILD=$BUILD"
  echo "WKSP=$WKSP"
  echo "AFFINITY=$AFFINITY"
  echo "APP=$APPNAME"
  echo "POD=$POD"
  echo "RUN_ARGS=\"$RUN_ARGS\""
  echo "MON_ARGS=\"$MON_ARGS\""
  echo "MAIN_CNC=$MAIN_CNC"
  echo "TQOS_CNC=$TQOS_CNC"
  echo "TMON_CNC=$TMON_CNC"
} >> "$CONF"

#######################################################################

echo Autogenerated configuration at "$CONF"
echo ""
cat "$CONF"
echo ""

echo Configuration details
echo ""
"$BUILD"/bin/fd_pod_ctl list "$POD" 2> /dev/null || exit $?
echo ""

echo success
exit 0

