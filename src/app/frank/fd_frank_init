#!/bin/bash

if [ $# -lt 4 ]; then
  echo ""
<<<<<<< HEAD
  echo "        Usage: $0 [APP_NAME] [APP_CORE_TARGET] [QUIC_CNT] [VERIFY_CNT] [BUILD]"
=======
  echo "        Usage: $0 [APP_NAME] [APP_CORE_TARGET] [VERIFY_CNT] [BUILD] [PAGE_SIZE]"
>>>>>>> prelim-mac-support
  echo ""
  exit 1
fi

APP=$1
AFFINITY=$2
<<<<<<< HEAD
QUIC_CNT=$3
VERIFY_CNT=$4
BUILD=$5
shift 5

=======
VERIFY_CNT=$3
BUILD=$4
if [ -z "$5" ]; then
  WKSP_PAGE_SZ=""
  shift 4
else
  WKSP_PAGE_SZ=$5
  shift 5
fi
  
>>>>>>> prelim-mac-support
#######################################################################

CONF=tmp/$APP.cfg

WKSP=$APP.wksp
WKSP_PERM=0600

POD_SZ=16384

CNC_APP_SZ=4032

QUIC_TILE_DEPTH=8192
QUIC_MSG_SZ=2048

VERIFY_DEPTH=8192
VERIFY_MTU=2048

DEDUP_TCACHE_DEPTH=4194302
DEDUP_TCACHE_MAP_CNT=0
DEDUP_DEPTH=$VERIFY_DEPTH

<<<<<<< HEAD
PACK_BANK_CNT=4
PACK_PRQ_SZ=4096
PACK_CU_EST_TBL_SZ=1024
PACK_CU_EST_HISTORY=1000
PACK_CU_EST_DEFAULT=200000
PACK_CU_LIMIT=12000001
=======
# Set a sensible default for page size depending on OS and architecture platform in use;
# Linux x64: gigantic
# macOS x64 Intel: huge (superpages)
# macOS ARM (M1/M2): normal
OS_STR=`uname -s`
ARCH_STR=`uname -m`
if [[ "$OS_STR" == "Linux" ]] && [[ "$ARCH_STR" == "x86_64" ]]; then
  PLATFORM_DEFAULT_WKSP_PAGE_SZ=gigantic
elif [[ "$OS_STR" == "Darwin" ]] && [[ "$ARCH_STR" == "x86_64" ]]; then
  VERSION_LEVEL_STR=`uname -v`
  if [[ "$VERSION_LEVEL_STR" == *"ARM64"* ]]; then
    PLATFORM_DEFAULT_WKSP_PAGE_SZ=normal
  else
    PLATFORM_DEFAULT_WKSP_PAGE_SZ=huge
  fi
elif [[ "$OS_STR" == "Darwin" ]] && [[ "$ARCH_STR" == "arm64" ]]; then
  echo "Run firedancer under Rosetta on macOS M1 and M2 systems"
  exit 1
else
  echo "Firedancer is not supported on this platform"
  exit 1
fi

# Allow override of platform's default page size via a command line argument
# If PAGE_SIZE argument was not provided at the command line, use the platform's default,
# as determined above.
if [[ -z "$WKSP_PAGE_SZ" ]]; then
  WKSP_PAGE_SZ=$PLATFORM_DEFAULT_WKSP_PAGE_SZ
fi

if [ "$WKSP_PAGE_SZ" != "huge" ] && [ "$WKSP_PAGE_SZ" != "gigantic" ] && [ "$WKSP_PAGE_SZ" != "normal" ]; then
  echo "fd_frank_init fail, invalid page size '$WKSP_PAGE_SZ' specified"
  exit 1
fi

if [[ "$WKSP_PAGE_SZ" == "gigantic" ]]; then
  WKSP_PAGE_CNT=2
elif [[ "$WKSP_PAGE_SZ" == "huge" ]]; then
  WKSP_PAGE_CNT=1024
elif [[ "$WKSP_PAGE_SZ" == "normal" ]]; then
  WKSP_PAGE_CNT=524288
fi    
>>>>>>> prelim-mac-support

#######################################################################

FD_LOG_PATH=""
export FD_LOG_PATH

$BUILD/bin/fd_wksp_ctl delete $WKSP # Okay if fails ... might not exist already
$BUILD/bin/fd_wksp_ctl new $WKSP $WKSP_PAGE_CNT $WKSP_PAGE_SZ $AFFINITY $WKSP_PERM || exit $?

POD=`$BUILD/bin/fd_pod_ctl new $WKSP $POD_SZ` || exit $?

MAIN_CNC=`$BUILD/bin/fd_tango_ctl new-cnc $WKSP 0 tic $CNC_APP_SZ` || exit $?
$BUILD/bin/fd_pod_ctl                      \
  insert $POD cstr $APP.main.cnc $MAIN_CNC \
  || exit $?

CNC=`$BUILD/bin/fd_tango_ctl new-cnc $WKSP 0 tic $CNC_APP_SZ` || exit $?
MCACHE=`$BUILD/bin/fd_tango_ctl new-mcache $WKSP $PACK_PRQ_SZ 0 0` || exit $?
DCACHE=`$BUILD/bin/fd_tango_ctl new-dcache $WKSP 4808 $PACK_PRQ_SZ 1 1 0` || exit $?
PACK_SCRATCH=`$BUILD/bin/fd_pack_ctl new-scratch $WKSP $PACK_BANK_CNT $PACK_PRQ_SZ ` || exit $?
CU_EST_TBL=`$BUILD/bin/fd_pack_ctl new-cu-est-tbl $WKSP $PACK_CU_EST_TBL_SZ $PACK_CU_EST_HISTORY $PACK_CU_EST_DEFAULT` || exit $?
RETURN_FSEQ=`$BUILD/bin/fd_tango_ctl new-fseq $WKSP 0` || exit $?
$BUILD/bin/fd_pod_ctl                                           \
  insert $POD cstr  $APP.pack.cnc           $CNC                \
  insert $POD cstr  $APP.pack.out-mcache    $MCACHE             \
  insert $POD cstr  $APP.pack.out-dcache    $DCACHE             \
  insert $POD cstr  $APP.pack.scratch       $PACK_SCRATCH       \
  insert $POD cstr  $APP.pack.cu-est-tbl    $CU_EST_TBL         \
  insert $POD cstr  $APP.pack.return-fseq   $RETURN_FSEQ        \
  insert $POD ulong $APP.pack.bank-cnt      $PACK_BANK_CNT      \
  insert $POD ulong $APP.pack.txnq-sz       $PACK_PRQ_SZ        \
  insert $POD ulong $APP.pack.cu-est-tbl-sz $PACK_CU_EST_TBL_SZ \
  insert $POD uint  $APP.pack.cu-limit      $PACK_CU_LIMIT      \
  || exit $?

CNC=`$BUILD/bin/fd_tango_ctl new-cnc $WKSP 1 tic $CNC_APP_SZ` || exit $?
TCACHE=`$BUILD/bin/fd_tango_ctl new-tcache $WKSP $DEDUP_TCACHE_DEPTH $DEDUP_TCACHE_MAP_CNT` || exit $?
MCACHE=`$BUILD/bin/fd_tango_ctl new-mcache $WKSP $DEDUP_DEPTH 0 0` || exit $?
FSEQ=`$BUILD/bin/fd_tango_ctl new-fseq $WKSP 0` || exit $?
# Use defaults for cr_max, lazy, seed
$BUILD/bin/fd_pod_ctl                        \
  insert $POD cstr $APP.dedup.cnc    $CNC    \
  insert $POD cstr $APP.dedup.tcache $TCACHE \
  insert $POD cstr $APP.dedup.mcache $MCACHE \
  insert $POD cstr $APP.dedup.fseq   $FSEQ   \
  || exit $?

for((quic_idx=0;quic_idx<QUIC_CNT;quic_idx++)); do
  CNC=`$BUILD/bin/fd_tango_ctl new-cnc $WKSP 2 tic $CNC_APP_SZ` || exit $?
  MCACHE=`$BUILD/bin/fd_tango_ctl new-mcache $WKSP $QUIC_TILE_DEPTH 0 0` || exit $?
  DCACHE=`$BUILD/bin/fd_tango_ctl new-dcache $WKSP $QUIC_MSG_SZ $QUIC_TILE_DEPTH 1 1 0` || exit $?
  $BUILD/bin/fd_pod_ctl \
    insert $POD cstr $APP.quic${quic_idx}.cnc    $CNC    \
    insert $POD cstr $APP.quic${quic_idx}.mcache $MCACHE \
    insert $POD cstr $APP.quic${quic_idx}.dcache $DCACHE \
    || exit $?
done

for((verify_idx=0;verify_idx<VERIFY_CNT;verify_idx++)); do
  IN_CNC=`$BUILD/bin/fd_tango_ctl new-cnc $WKSP 2 tic $CNC_APP_SZ` || exit $?
  IN_MCACHE=`$BUILD/bin/fd_tango_ctl new-mcache $WKSP $VERIFY_DEPTH 0 0` || exit $?
  IN_DCACHE=`$BUILD/bin/fd_tango_ctl new-dcache $WKSP $VERIFY_MTU $VERIFY_DEPTH 1 1 0` || exit $?
  IN_FSEQ=`$BUILD/bin/fd_tango_ctl new-fseq $WKSP 0` || exit $?
  $BUILD/bin/fd_pod_ctl                                      \
    insert $POD cstr $APP.verifyin.v${verify_idx}in.cnc    $IN_CNC    \
    insert $POD cstr $APP.verifyin.v${verify_idx}in.mcache $IN_MCACHE \
    insert $POD cstr $APP.verifyin.v${verify_idx}in.dcache $IN_DCACHE \
    insert $POD cstr $APP.verifyin.v${verify_idx}in.fseq   $IN_FSEQ   \
    || exit $?

  CNC=`$BUILD/bin/fd_tango_ctl new-cnc $WKSP 2 tic $CNC_APP_SZ` || exit $?
  MCACHE=`$BUILD/bin/fd_tango_ctl new-mcache $WKSP $VERIFY_DEPTH 0 0` || exit $?
  DCACHE=`$BUILD/bin/fd_tango_ctl new-dcache $WKSP $VERIFY_MTU $VERIFY_DEPTH 1 1 0` || exit $?
  FSEQ=`$BUILD/bin/fd_tango_ctl new-fseq $WKSP 0` || exit $?
  $BUILD/bin/fd_pod_ctl                                      \
    insert $POD cstr $APP.verify.v$verify_idx.cnc    $CNC    \
    insert $POD cstr $APP.verify.v$verify_idx.mcache $MCACHE \
    insert $POD cstr $APP.verify.v$verify_idx.dcache $DCACHE \
    insert $POD cstr $APP.verify.v$verify_idx.fseq   $FSEQ   \
    || exit $?
done

BASE_ARGS="--pod $POD --cfg $APP"
RUN_ARGS="$BASE_ARGS --log-app $APP --log-thread main"
MON_ARGS="$BASE_ARGS --log-app $APP --log-thread mon"

#######################################################################

mkdir -pv `dirname $CONF` || exit $?
echo "#!/bin/bash"             >  $CONF
echo "# AUTOGENERATED"         >> $CONF
echo "BUILD=$BUILD"            >> $CONF
echo "WKSP=$WKSP"              >> $CONF
echo "AFFINITY=$AFFINITY"      >> $CONF
echo "APP=$APP"                >> $CONF
echo "POD=$POD"                >> $CONF
echo "RUN_ARGS=\"$RUN_ARGS\""  >> $CONF
echo "MON_ARGS=\"$MON_ARGS\""  >> $CONF
echo "MAIN_CNC=$MAIN_CNC"      >> $CONF

#######################################################################

echo Autogenerated configuration at $CONF
echo ""
cat $CONF
echo ""

echo Configuration details
echo ""
$BUILD/bin/fd_pod_ctl list $POD 2> /dev/null || exit $?
echo ""

echo success
exit 0
